import{createComponent as e}from"solid-js/web";import{createStore as n,produce as t}from"solid-js/store";import{createContext as o,on as r,useContext as i,createRoot as l,createComputed as a,createEffect as s,onCleanup as d}from"solid-js";var c=o({elements:{},symbolClose:Symbol("close"),info:{frozen:!1,cbOnOff:"off",currComponentId:"",prevComponentId:""},setInfo:()=>{},insertElement:()=>{},onDeactivated:()=>{},onActivated:()=>{},removeAliveElements:()=>{},insertCacheCb:()=>{},setCurrcomponent:()=>{}});function v(o){let[i,l]=n(),a={frozen:!1,cbOnOff:"off",currComponentId:"",prevComponentId:""},s=Symbol("close"),d=new Map,v=new Map,f={onActivated:{},onDeactivated:{}};var u=e=>{var n;if(Reflect.has(i,e)){var t=null===(n=i[e])||void 0===n?void 0:n.subIds;null==t||t.forEach((n=>n!==e&&u(n))),l((n=>{var t,o;return null===(o=(t=n[e]).dispose)||void 0===o||o.call(t),n[e].dispose=null,n[e]=null,delete n[e],n}))}},m=e=>{var{caller:n,path:t}=function(){var e=null,n=null;try{throw new Error}catch(l){var t=l.stack.split("\n"),o=t[0].includes("@")?5:6,r=t[o].trim(),i=r.includes("@")?r.split("@"):r.split(" ").slice(1);e=i[0],n=i[1]}return{caller:e,path:n}}(),o=f[e];return(!o[n]||o[n]===t)&&(f[e][n]=t,!0)},b=(e,n)=>{var{cbOnOff:t,currComponentId:o}=a;if("on"===t&&o!==s&&n&&m(e)){var i={onActivated:d,onDeactivated:v}[e],l=i.get(o)||new Set;l.add(r([],n))&&i.set(o,l)}};return e(c.Provider,{value:{info:a,elements:i,symbolClose:s,setInfo:(e,n)=>{a[e]=n},onActivated:e=>{b("onActivated",e)},onDeactivated:e=>{b("onDeactivated",e)},insertElement:e=>{let n=e.id,t=Object.values(i).find((e=>{var t;return null===(t=e.subIds)||void 0===t?void 0:t.has(n)}));l([n],Object.assign(Object.assign(Object.assign({},i[n]),e),{fatherId:null==t?void 0:t.id}))},removeAliveElements:e=>{if(Array.isArray(e))for(const n of e)u(n);else if(!e)for(const e of Object.values(i))u(e.id)},insertCacheCb:e=>{let n=d.get(e),o=v.get(e);d.delete(e),v.delete(e),f.onActivated={},f.onDeactivated={},Reflect.has(i,e)&&l(t((t=>{t[e].onActivated=n,t[e].onDeactivated=o,t[e].loaded=!0})))},setCurrcomponent:e=>{a.currComponentId=e}},get children(){return o.children}})}let f=new Set([]);function u(e,n,t){return function(o){var{info:r,elements:v,symbolClose:u,setInfo:m,insertElement:b,insertCacheCb:p,setCurrcomponent:A}=i(c);Reflect.has(v,n)||l((r=>{A(n),m("cbOnOff","on"),b({id:n,dispose:r,owner:null,element:e(o),subIds:Array.isArray(t)?new Set(t):null})}));var O=e=>{var n=v[e].fatherId;return n?O(n):e};return a((()=>{var e,t;if(v[n].loaded)return;let o=null===(e=v[n])||void 0===e?void 0:e.element;for(;"function"==typeof o;)o=o();(Array.isArray(o)||o instanceof HTMLElement)&&(p(n),!(null===(t=v[n].subIds)||void 0===t?void 0:t.size)&&A(u))})),f.size&&!f.has(O(n))&&f.clear(),s((()=>{var e,t;r.frozen?!(null===(e=v[n].subIds)||void 0===e?void 0:e.size)&&m("frozen",!1):v[n].loaded&&(f.add(n),m("cbOnOff","off"),null===(t=v[n].onActivated)||void 0===t||t.forEach((e=>e())),m("cbOnOff","on"))})),d((()=>{var e;r.frozen||(m("cbOnOff","off"),null===(e=v[n].onDeactivated)||void 0===e||e.forEach((e=>e())),m("cbOnOff","on"))})),v[n].element}}function m(n){var t=u((()=>n.children),n.id,n.subIds);return e(t,{})}function b(){var{onActivated:e,onDeactivated:n,removeAliveElements:t,setInfo:o}=i(c);return{onActivated:e,onDeactivated:n,removeAliveElements:t,setInfo:o}}function p(e){var{onActivated:n}=b();n(e)}function A(e){var{onDeactivated:n}=b();n(e)}function O(){var{removeAliveElements:e,setInfo:n}=b();return{removeAliveElements:e,aliveFrozen:()=>n("frozen",!0)}}export{m as AliveComponent,v as AliveProvider,u as aliveTransfer,p as onActivated,A as onDeactivated,O as useAlive};
