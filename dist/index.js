import{createComponent as e}from"solid-js/web";import{createStore as n,produce as o}from"solid-js/store";import{createContext as r,createComputed as t,on as i,useContext as l,createRoot as s,getOwner as d,onCleanup as v,runWithOwner as a}from"solid-js";var c=r({elements:{},symbolClose:Symbol("close"),info:{frozen:!1,cbOnOff:"off",currComponentId:""},insertElement:()=>{},removeAliveElements:()=>{},setCb:()=>{}});function f(r){let[l,s]=n(),d=Symbol("close"),v={frozen:!1,cbOnOff:"on",currComponentId:d,aliveIds:null};var a=e=>{var n,o,r;l[e]&&(null===(n=l[e].subIds)||void 0===n||n.forEach((n=>n!==e&&a(n))),null===(r=(o=l[e]).dispose)||void 0===r||r.call(o),s({[e]:void 0}))},f=e=>{if(Array.isArray(e))for(const n of e)a(n);else if(!e)for(const e of Object.keys(l))a(e)};return t((e=>{var n=Array.isArray(r.include),o=n?r.include:[];return v.aliveIds=n?r.include:null,e.length>o.length&&f(e.filter((e=>!o.includes(e)))),o}),Array.isArray(r.include)?r.include:[]),e(c.Provider,{value:{info:v,elements:l,symbolClose:d,setCb:(e,n)=>{var r=v.cbOnOff,t=v.currComponentId;"on"===r&&"string"==typeof t&&n&&(!l[t]&&s(t,{}),s(o((o=>{o[t][e]=[...o[t][e]||[],i([],n)]}))),"onActivated"===e&&Promise.resolve().then((()=>{v.cbOnOff="off",n(),v.cbOnOff="on"})))},insertElement:e=>{s([e.id],Object.assign(Object.assign({},l[e.id]),e))},removeAliveElements:f},get children(){return r.children}})}function u(e,n,o){return function(r){var t,{info:i,elements:f,symbolClose:u,insertElement:m}=l(c);return Array.isArray(i.aliveIds)&&!i.aliveIds.includes(n)?e(r):(f[n]?(i.currComponentId=u,i.frozen?!(null===(t=f[n].subIds)||void 0===t?void 0:t.length)&&(i.frozen=!1):Promise.resolve().then((()=>{var e;return null===(e=f[n].onActivated)||void 0===e?void 0:e.forEach((e=>e()))}))):(i.currComponentId=n,s((t=>{m({id:n,dispose:t,owner:d(),element:e(r),subIds:Array.isArray(o)?o:null})}))),v((()=>{var e,o;i.frozen||(i.currComponentId=u,null===(o=null===(e=f[n])||void 0===e?void 0:e.onDeactivated)||void 0===o||o.forEach((e=>e())))})),f[n].owner&&a(f[n].owner,(()=>f[n].element)))}}function m(n){var o=u((()=>n.children),n.id,n.subIds);return e(o,{})}function A(){var{setCb:e,removeAliveElements:n,info:o}=l(c);return{onActivated:n=>e("onActivated",n),onDeactivated:n=>e("onDeactivated",n),removeAliveElements:n,info:o}}function b(e){var{onActivated:n}=A();n(e)}function y(e){var{onDeactivated:n}=A();n(e)}function I(){var{removeAliveElements:e,info:n,onActivated:o,onDeactivated:r}=A();return{onActivated:o,onDeactivated:r,removeAliveElements:e,aliveFrozen:()=>n.frozen=!0}}export{m as AliveComponent,f as AliveProvider,u as aliveTransfer,b as onActivated,y as onDeactivated,I as useAlive};
