import{createComponent as e}from"solid-js/web";import{createStore as n,produce as o}from"solid-js/store";import{createContext as t,createComputed as r,on as i,useContext as l,createRoot as s,getOwner as d,createEffect as a,onCleanup as f,runWithOwner as v}from"solid-js";var c=t({elements:{},symbolClose:Symbol("close"),info:{frozen:!1,cbOnOff:"off",currComponentId:""},setInfo:()=>{},insertElement:()=>{},removeAliveElements:()=>{},insertCacheCb:()=>{},setCb:()=>{}});function u(t){let[l,s]=n(),d={frozen:!1,cbOnOff:"off",currComponentId:""},a=Symbol("close"),f=new Map,v=new Map;var u=e=>{let n=e.id,o=Object.values(l).find((e=>{var o;return null===(o=e.subIds)||void 0===o?void 0:o.has(n)}));s([n],Object.assign(Object.assign(Object.assign({},l[n]),e),{fatherId:null==o?void 0:o.id}))},m=e=>{let n=f.get(e),t=v.get(e);f.delete(e),v.delete(e),Reflect.has(l,e)&&s(o((o=>{o[e].onActivated=n,o[e].onDeactivated=t,o[e].loaded=!0})))},b=e=>{var n,o,t;if(Reflect.has(l,e)){var r=null===(n=l[e])||void 0===n?void 0:n.subIds;null==r||r.forEach((n=>n!==e&&b(n))),null===(t=(o=l[e]).dispose)||void 0===t||t.call(o),s({[e]:void 0})}},O=e=>{if(Array.isArray(e))for(const n of e)b(n);else if(!e)for(const e of Object.values(l))b(e.id)},I=(e,n)=>{var{cbOnOff:o,currComponentId:t}=d;if("on"===o&&t!==a&&n){var r={onActivated:f,onDeactivated:v}[e],l=r.get(t)||new Set;l.add(i([],n))&&r.set(t,l)}},h=(e,n)=>{d[e]=n};return r(((e=[])=>{var n=t.includes||[];if(e.length>n.length){var o=new Set(n);O(e.filter((e=>!o.has(e))))}return n}),t.includes||[]),e(c.Provider,{get value(){return{info:d,elements:l,symbolClose:a,setInfo:h,setCb:I,insertElement:u,removeAliveElements:O,insertCacheCb:m,aliveIds:t.includes}},get children(){return t.children}})}function m(e,n,o){return function(t){var{info:i,elements:u,symbolClose:m,setInfo:b,insertElement:O,insertCacheCb:I,aliveIds:h}=l(c);if(!h||!h.includes(n))return e(t);!Reflect.has(u,n)&&s((r=>{b("currComponentId",n),b("cbOnOff","on"),O({id:n,dispose:r,owner:d(),element:e(t),subIds:Array.isArray(o)?new Set(o):null})}));return r((()=>{var e;!u[n].loaded&&(e=>{for(var n,o=null===(n=u[e])||void 0===n?void 0:n.element;"function"==typeof o;)o=o();return o})(n)&&(I(n),!(null===(e=u[n].subIds)||void 0===e?void 0:e.size)&&b("currComponentId",m))})),a((()=>{var e,o,t;i.frozen?!(null===(e=u[n].subIds)||void 0===e?void 0:e.size)&&b("frozen",!1):(null===(o=u[n])||void 0===o?void 0:o.loaded)&&(b("cbOnOff","off"),null===(t=u[n].onActivated)||void 0===t||t.forEach((e=>e())),b("cbOnOff","on"))})),f((()=>{var e,o;i.frozen||(b("cbOnOff","off"),null===(o=null===(e=u[n])||void 0===e?void 0:e.onDeactivated)||void 0===o||o.forEach((e=>e())),b("cbOnOff","on"))})),u[n].owner&&v(u[n].owner,(()=>u[n].element))}}function b(n){var o=m((()=>n.children),n.id,n.subIds);return e(o,{})}function O(){var{setCb:e,removeAliveElements:n,setInfo:o}=l(c);return{onActivated:n=>e("onActivated",n),onDeactivated:n=>e("onDeactivated",n),removeAliveElements:n,setInfo:o}}function I(e){var{onActivated:n}=O();n(e)}function h(e){var{onDeactivated:n}=O();n(e)}function A(){var{removeAliveElements:e,setInfo:n}=O();return{onActivated:I,onDeactivated:h,removeAliveElements:e,aliveFrozen:()=>n("frozen",!0)}}export{b as AliveComponent,u as AliveProvider,m as aliveTransfer,I as onActivated,h as onDeactivated,A as useAlive};
