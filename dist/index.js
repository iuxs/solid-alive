import{createComponent as e}from"solid-js/web";import{createStore as t,produce as n}from"solid-js/store";import{createContext as r,on as o,useContext as i,createRoot as a,createComputed as l,createEffect as v,onCleanup as d}from"solid-js";var s=r({elements:{},info:{frozen:!1},setInfo:()=>{},insertElement:()=>{},onDeactivated:()=>{},onActivated:()=>{},removeAliveElements:()=>{},setCurrentComponentId:()=>{},insertCacheCb:()=>{}});function c(r){let[i,a]=t(),[l,v]=t({frozen:!0}),d="",c=new Map,f=new Map,u={onActivated:{},onDeactivated:{}};var m=e=>{var t;if(Reflect.has(i,e)){var n=null===(t=i[e])||void 0===t?void 0:t.subIds;null==n||n.forEach((t=>t!==e&&m(t))),a((t=>{var n,r;return null===(r=(n=t[e]).dispose)||void 0===r||r.call(n),t[e]=null,delete t[e],t}))}},A=e=>{var{caller:t,path:n}=function(){var e=null,t=null;try{throw new Error}catch(a){var n=a.stack.split("\n"),r=n[0].includes("@")?5:6,o=n[r].trim(),i=o.includes("@")?o.split("@"):o.split(" ").slice(1);e=i[0],t=i[1]}return{caller:e,path:t}}(),r=u[e];return(!r[t]||r[t]===n)&&(u[e][t]=n,!0)},h=(e,t)=>{if(!l.frozen&&t&&A(e)){var n={onActivated:c,onDeactivated:f}[e],r=n.get(d)||new Set;r.add(o([],t))&&n.set(d,r)}};return e(s.Provider,{value:{info:l,elements:i,setInfo:v,onActivated:e=>{h("onActivated",e)},onDeactivated:e=>{h("onDeactivated",e)},insertElement:e=>{let t=e.id;a([t],Object.assign(Object.assign({},i[t]),e))},removeAliveElements:e=>{if(e&&Array.isArray(e))for(const t of e)m(t);else for(const e of Object.values(i))m(e.id)},setCurrentComponentId:e=>{d=e},insertCacheCb:e=>{let t=c.get(e),r=f.get(e);c.delete(e),f.delete(e),u.onActivated={},u.onDeactivated={},Reflect.has(i,e)&&a(n((n=>{n[e].onActivated=t,n[e].onDeactivated=r,n[e].loaded=!0})))}},get children(){return r.children}})}let f=new Set([]);function u(e,t,n,r){return function(o){var{info:c,elements:u,setInfo:m,insertElement:A,setCurrentComponentId:h,insertCacheCb:p}=i(s);Reflect.has(u,t)||(m("frozen",!1),h(t),a((i=>{A({id:t,dispose:i,owner:null,component:r?e:null,element:e(o),subIds:Array.isArray(n)?new Set(n):null})})));var E=e=>{var t;if(u[e].isTop)return e;var n=null===(t=Object.values(u).find((t=>{var n;return null===(n=t.subIds)||void 0===n?void 0:n.has(e)})))||void 0===t?void 0:t.id;return n&&(n=E(n)),n||e};return f.has(E(t))||f.clear(),l((()=>{var e;if(!u[t].loaded){let n=null===(e=u[t])||void 0===e?void 0:e.element;for(;"function"==typeof n;)n=n();n instanceof HTMLElement&&p(t)}})),v((()=>{var e;m("frozen",!1),f.has(t)||u[t].loaded&&(f.add(t),m("frozen",!0),null===(e=u[t].onActivated)||void 0===e||e.forEach((e=>e())),m("frozen",!1))})),d((()=>{var e;c.frozen||(m("frozen",!0),null===(e=u[t].onDeactivated)||void 0===e||e.forEach((e=>e())))})),u[t].element}}function m(t){var n=u((()=>t.children),t.id,t.subIds);return e(n,{})}function A(){var{onActivated:e,onDeactivated:t,removeAliveElements:n,setInfo:r}=i(s);return{onActivated:e,onDeactivated:t,removeAliveElements:n,setInfo:r}}function h(e){var{onActivated:t}=A();t(e)}function p(e){var{onDeactivated:t}=A();t(e)}function E(){var{removeAliveElements:e,setInfo:t}=A();return{removeAliveElements:e,aliveFrozen:()=>t("frozen",!0)}}export{m as AliveComponent,c as AliveProvider,u as aliveTransfer,h as onActivated,p as onDeactivated,E as useAlive};
