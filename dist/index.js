import{createComponent as e}from"solid-js/web";import{createStore as t,produce as n}from"solid-js/store";import{createContext as r,on as o,useContext as a,createRoot as i,createComputed as l,createEffect as s,onCleanup as d}from"solid-js";var v=r({elements:{},info:{frozen:!1},setInfo:()=>{},insertElement:()=>{},onDeactivated:()=>{},onActivated:()=>{},removeAliveElements:()=>{},setCurrentComponentId:()=>{},insertCacheCb:()=>{}});function c(r){let[a,i]=t(),[l,s]=t({frozen:!0}),d="",c=new Map,f=new Map,u={onActivated:{},onDeactivated:{}};var m=e=>{var t;if(Reflect.has(a,e)){var n=null===(t=a[e])||void 0===t?void 0:t.subIds;null==n||n.forEach((t=>t!==e&&m(t))),i((t=>{var n,r;return null===(r=(n=t[e]).dispose)||void 0===r||r.call(n),t[e]=null,delete t[e],t}))}},A=e=>{var{caller:t,path:n}=function(){var e=null,t=null;try{throw new Error}catch(i){var n=i.stack.split("\n"),r=n[0].includes("@")?5:6,o=n[r].trim(),a=o.includes("@")?o.split("@"):o.split(" ").slice(1);e=a[0],t=a[1]}return{caller:e,path:t}}(),r=u[e];return(!r[t]||r[t]===n)&&(u[e][t]=n,!0)},h=(e,t)=>{if(!l.frozen&&t&&A(e)){var n={onActivated:c,onDeactivated:f}[e],r=n.get(d)||new Set;r.add(o([],t))&&n.set(d,r)}};return e(v.Provider,{value:{info:l,elements:a,setInfo:s,onActivated:e=>{h("onActivated",e)},onDeactivated:e=>{h("onDeactivated",e)},insertElement:e=>{let t=e.id;var n=Object.values(a).find((e=>{var n;return null===(n=e.subIds)||void 0===n?void 0:n.has(t)}));i([t],Object.assign(Object.assign(Object.assign({},a[t]),e),{fatherId:null==n?void 0:n.id}))},removeAliveElements:e=>{if(Array.isArray(e))for(const t of e)m(t);else if(!e)for(const e of Object.values(a))m(e.id)},setCurrentComponentId:e=>{d=e},insertCacheCb:e=>{let t=c.get(e),r=f.get(e);c.delete(e),f.delete(e),u.onActivated={},u.onDeactivated={},Reflect.has(a,e)&&i(n((n=>{n[e].onActivated=t,n[e].onDeactivated=r,n[e].loaded=!0})))}},get children(){return r.children}})}let f=new Set([]);function u(e,t,n){return function(r){var{info:o,elements:c,setInfo:u,insertElement:m,setCurrentComponentId:A,insertCacheCb:h}=a(v);Reflect.has(c,t)||(u("frozen",!1),A(t),i((o=>{m({id:t,dispose:o,owner:null,element:e(r),subIds:Array.isArray(n)?new Set(n):null})})));var p=e=>{var t=c[e].fatherId;return t?p(t):e};return l((()=>{var e;if(c[t].loaded)return;let n=null===(e=c[t])||void 0===e?void 0:e.element;for(;"function"==typeof n;)n=n();(Array.isArray(n)||n instanceof HTMLElement)&&h(t)})),f.size&&!f.has(p(t))&&f.clear(),s((()=>{var e;u("frozen",!1),f.has(t)||c[t].loaded&&(f.add(t),u("frozen",!0),null===(e=c[t].onActivated)||void 0===e||e.forEach((e=>e())),u("frozen",!1))})),d((()=>{var e;o.frozen||(u("frozen",!0),null===(e=c[t].onDeactivated)||void 0===e||e.forEach((e=>e())))})),c[t].element}}function m(t){var n=u((()=>t.children),t.id,t.subIds);return e(n,{})}function A(){var{onActivated:e,onDeactivated:t,removeAliveElements:n,setInfo:r}=a(v);return{onActivated:e,onDeactivated:t,removeAliveElements:n,setInfo:r}}function h(e){var{onActivated:t}=A();t(e)}function p(e){var{onDeactivated:t}=A();t(e)}function I(){var{removeAliveElements:e,setInfo:t}=A();return{removeAliveElements:e,aliveFrozen:()=>t("frozen",!0)}}export{m as AliveComponent,c as AliveProvider,u as aliveTransfer,h as onActivated,p as onDeactivated,I as useAlive};
